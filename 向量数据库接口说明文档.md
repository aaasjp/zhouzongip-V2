# 向量数据库接口说明文档

## 概述

本文档描述了向量数据库服务的所有API接口。所有接口均使用POST方法，请求和响应均为JSON格式。

**基础URL**: `http://host:port/vector_db_service/`

**默认端口**: 8004

**认证方式**: 所有接口都需要在请求体中包含 `api_key` 参数进行认证。

---

## 通用参数说明

### 请求参数
- `api_key` (string, 必填): API密钥，用于接口认证
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称

### 响应格式
所有接口返回统一的JSON格式：
```json
{
    "status": "success" | "fail",
    "code": 200 | 400,
    "msg": "响应消息",
    "data": "响应数据"
}
```

---

## 接口列表

### 1. 创建知识库

**接口路径**: `/vector_db_service/new_collection`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou"
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "成功创建向量库",
    "data": ""
}
```

---

### 2. 删除知识库

**接口路径**: `/vector_db_service/del_collection`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou"
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "成功删除向量库",
    "data": ""
}
```

---

### 3. 添加问答对

**接口路径**: `/vector_db_service/add_qa`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "question": "1+1等于多少？",
    "answer": "1+1=2",
    "source": "data/qa/wiki.txt"
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `question` (string, 必填): 问题内容
- `answer` (string, 必填): 答案内容
- `source` (string, 可选): 来源标识

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "成功插入问答对到向量库",
    "data": ""
}
```

---

### 4. 从模板添加问答对

**接口路径**: `/vector_db_service/add_qa_from_template`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "template_path": "/data/问答库模板.xlsx"
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `template_path` (string, 必填): 模板文件路径（本地文件系统路径）

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "成功插入问答对到向量库",
    "data": ""
}
```

---

### 5. 添加文档

**接口路径**: `/vector_db_service/add_document`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "doc_url": "http://example.com/document.pdf",
    "doc_name": "产品手册"
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `doc_url` (string, 必填): 文档URL（支持HTTP/HTTPS协议）
- `doc_name` (string, 必填): 文档名称

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "成功插入文档到向量库",
    "data": ""
}
```

**注意事项**:
- `doc_url` 必须是有效的URL格式（包含协议和域名）
- 文档将通过OCR服务进行解析，支持PDF等格式

---

### 6. 批量添加文档

**接口路径**: `/vector_db_service/add_multi_document`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "multi_doc_urls": [
        "http://example.com/doc1.pdf",
        "http://example.com/doc2.pdf"
    ],
    "doc_names": [
        "文档1",
        "文档2"
    ]
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `multi_doc_urls` (array, 必填): 文档URL列表
- `doc_names` (array, 必填): 文档名称列表，长度必须与 `multi_doc_urls` 一致

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "插入文档到向量库[xiaoshou]成功",
    "data": ""
}
```

**部分失败响应示例**:
```json
{
    "status": "fail",
    "code": 400,
    "msg": "插入文档到向量库[xiaoshou]：成功[1]个,失败[1]个",
    "data": ""
}
```

---

### 7. 更新问答对

**接口路径**: `/vector_db_service/update_qa`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "question": "1+1等于多少？",
    "answer": "1+1=2",
    "source": "data/qa/updated_wiki.txt"
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `question` (string, 必填): 问题内容（用于匹配要更新的问答对）
- `answer` (string, 必填): 新的答案内容
- `source` (string, 可选): 来源标识

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "成功更新问答对到向量库",
    "data": ""
}
```

---

### 8. 删除问答对

**接口路径**: `/vector_db_service/del_qa`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "question": ["1+1等于多少？", "2+2等于多少？"]
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `question` (array, 必填): 要删除的问题列表

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "从向量库删除问答对成功",
    "data": ""
}
```

---

### 9. 删除文档

**接口路径**: `/vector_db_service/del_document`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "doc_name": ["产品手册", "用户指南"]
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `doc_name` (array, 必填): 要删除的文档名称列表

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "从向量库删除文档成功",
    "data": ""
}
```

---

### 10. 搜索向量库

**接口路径**: `/vector_db_service/search_from_vector_db`

**请求方法**: POST

**请求参数**:
```json
{
    "api_key": "2024_hello_ai",
    "tenant_code": "xiaomi",
    "collection_name": "xiaoshou",
    "query": "产品介绍",
    "collection_type": "DOC",
    "filter_expr": "",
    "limit": 5
}
```

**参数说明**:
- `api_key` (string, 必填): API密钥
- `tenant_code` (string, 必填): 租户统一编码
- `collection_name` (string, 必填): 知识库名称
- `query` (string, 必填): 搜索查询内容
- `collection_type` (string, 必填): 集合类型，可选值: `QA`（问答对）或 `DOC`（文档）
- `filter_expr` (string, 可选): 过滤表达式（Milvus过滤语法）
- `limit` (integer, 可选): 返回结果数量，默认值为5

**响应示例**:
```json
{
    "status": "success",
    "code": 200,
    "msg": "从向量库查询成功",
    "data": [
        {
            "id": "xxx",
            "distance": 0.85,
            "entity": {
                "question": "...",
                "answer": "...",
                "source": "..."
            }
        }
    ]
}
```

---

## 错误码说明

- `200`: 请求成功
- `400`: 请求失败（参数错误、业务逻辑错误等）

## 常见错误

1. **api_key校验不通过**: 检查 `api_key` 是否正确
2. **缺少租户统一编码**: 确保请求中包含 `tenant_code` 参数
3. **缺少知识库名称参数**: 确保请求中包含 `collection_name` 参数
4. **文档URL格式不正确**: 确保 `doc_url` 包含协议（http://或https://）和域名
5. **文档URL列表长度不一致**: 确保 `multi_doc_urls` 和 `doc_names` 数组长度相同

---

## 使用示例

### Python示例

```python
import requests
import json

base_url = 'http://127.0.0.1:8004/vector_db_service/'
api_key = '2024_hello_ai'

# 创建知识库
data = {
    'tenant_code': 'xiaomi',
    'collection_name': 'xiaoshou',
    'api_key': api_key
}
response = requests.post(base_url + 'new_collection', json=data)
print(response.json())

# 添加问答对
data = {
    'tenant_code': 'xiaomi',
    'collection_name': 'xiaoshou',
    'api_key': api_key,
    'question': '1+1等于多少？',
    'answer': '1+1=2',
    'source': 'wiki'
}
response = requests.post(base_url + 'add_qa', json=data)
print(response.json())

# 搜索
data = {
    'tenant_code': 'xiaomi',
    'collection_name': 'xiaoshou',
    'api_key': api_key,
    'query': '数学',
    'collection_type': 'QA',
    'limit': 5
}
response = requests.post(base_url + 'search_from_vector_db', json=data)
print(response.json())
```

---

## 注意事项

1. 所有接口都需要通过 `api_key` 进行认证
2. 文档URL必须是可访问的HTTP/HTTPS链接
3. 批量操作时，部分失败会返回汇总信息
4. 删除操作支持批量删除（传入数组）
5. 搜索接口的 `collection_type` 必须指定为 `QA` 或 `DOC`
6. 模板文件路径必须是服务器本地文件系统路径

