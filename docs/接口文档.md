# 高管IP助手接口文档

本文档覆盖 `chat_server.py` 与 `vector_db_server.py` 中暴露的 HTTP 接口，包含调用方式、请求参数、响应格式及字段说明。所有接口默认返回 JSON，除特殊说明外均使用 `application/json`，响应结构统一为：

```json
{
  "status": "success | fail",
  "code": 200,
  "msg": "说明信息",
  "data": { }
}
```

- `status`: 接口执行结果；`success` 表示成功，`fail` 表示失败。
- `code`: 业务码，200 代表成功，其余为失败或异常场景（如 400、404、500）。
- `msg`: 文本说明。
- `data`: 具体数据载体，因接口而异；失败时通常为空字符串。

> 说明：示例 Host 记为 `http://<server_host>`，请按实际部署替换。

---

## 一、对话服务（chat_service）

### 1. 问答接口
- 路径：`POST /chat_service/chat`
- 功能：发起问答，支持流式或非流式输出，可结合素材库/上传文档/外部资源。
- 请求体（JSON）：
  - `user_id` *(string, 必填)*：用户唯一标识。
  - `session_id` *(string, 可选)*：会话 ID，不传则自动创建新会话并返回。
  - `question` *(string, 必填)*：用户问题。
  - `tenant_code` *(string, 可选)*：租户编码，用于数据隔离。
  - `org_code` *(string, 可选)*：组织编码，用于数据隔离。
  - `use_vector_db` *(bool, 默认 true)*：是否使用素材库检索（当未上传文档时）。
  - `uploaded_docs` *(array, 可选)*：已上传并解析的文档列表，元素格式 `{file_name, file_url, content, parse_success}`；当提供且 `parse_success=true` 时优先使用其内容。
  - `stream` *(bool, 默认 true)*：是否使用 Server-Sent Events 流式返回。
  - `limit` *(int, 可选)*：素材库检索条数，默认读取配置 `search_limit`（未配时 3）。
  - `chat_mode` *(string, 可选)*：`general`（默认）、`idea_gen`（创意生成）、`scripts_gen`（脚本生成）。
  - `use_external_resource` *(bool, 默认 false)*：是否启用外部资源（小红书）。
  - `theme` *(string, 可选)*：主题参数，当前预留（如 `tech_male`、`overseas_trip`）。

- 成功响应（非流式示例）：
```json
{
  "status": "success",
  "code": 200,
  "msg": "问答成功",
  "data": {
    "session_id": "<生成或传入的会话ID>",
    "answer": "AI回答文本",
    "sources": {
      "count": 1,
      "documents": [
        { "name": "文档名或问题", "url": "来源URL" }
      ]
    },
    "suggested_questions": ["延申问题1", "延申问题2"]
  }
}
```
- 成功响应（流式 SSE 格式）：`Content-Type: text/event-stream`，连续推送 `data: {...}`，直至 `done=true`，最终包包含完整 `content`、`sources`、`suggested_questions`。
- 失败示例：`{"status":"fail","code":400,"msg":"缺少用户ID","data":""}`。

### 2. 获取会话列表
- 路径：`GET /chat_service/sessions`
- 查询参数：
  - `user_id` *(string, 必填)*
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `limit` *(int, 默认 50)*：返回条数上限。
- 响应：`data` 为会话列表对象数组（字段同会话详情）。示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "获取会话列表成功",
    "data": [
      {
        "id": 12,
        "session_id": "3a7e...",
        "user_id": "u123",
        "title": "新对话",
        "tenant_code": "t1",
        "org_code": "orgA",
        "created_at": "2025-12-10 10:23:45",
        "updated_at": "2025-12-10 10:24:12",
        "is_deleted": 0
      }
    ]
  }
  ```

### 2.1. 获取格式化会话列表
- 路径：`GET /chat_service/sessions_format`
- 功能：获取按日期分组的会话列表，分为今天、昨天、最近七天三个时间段。
- 查询参数：
  - `user_id` *(string, 必填)*
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `limit` *(int, 默认 100)*：返回条数上限（用于获取更多会话进行分组）。
- 响应：`data` 为包含三个时间段的会话列表对象。示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "获取格式化会话列表成功",
    "data": {
      "todayHistoryList": [
        {
          "id": 15,
          "session_id": "3a7e...",
          "user_id": "u123",
          "title": "今天的对话",
          "tenant_code": "t1",
          "org_code": "orgA",
          "created_at": "2025-12-10 10:23:45",
          "updated_at": "2025-12-10 10:24:12",
          "is_deleted": 0
        }
      ],
      "yesterdayHistoryList": [
        {
          "id": 14,
          "session_id": "2b6d...",
          "user_id": "u123",
          "title": "昨天的对话",
          "tenant_code": "t1",
          "org_code": "orgA",
          "created_at": "2025-12-09 15:30:20",
          "updated_at": "2025-12-09 15:35:10",
          "is_deleted": 0
        }
      ],
      "sevenDaysHistoryList": [
        {
          "id": 13,
          "session_id": "1c5f...",
          "user_id": "u123",
          "title": "最近七天的对话",
          "tenant_code": "t1",
          "org_code": "orgA",
          "created_at": "2025-12-08 09:15:30",
          "updated_at": "2025-12-08 09:20:45",
          "is_deleted": 0
        }
      ]
    }
  }
  ```
- 说明：
  - `todayHistoryList`：今天的会话列表（按 `updated_at` 倒序）。
  - `yesterdayHistoryList`：昨天的会话列表（按 `updated_at` 倒序）。
  - `sevenDaysHistoryList`：最近七天（不包括今天和昨天）的会话列表（按 `updated_at` 倒序）。

### 3. 创建会话
- 路径：`POST /chat_service/session`
- 请求体（JSON）：
  - `user_id` *(string, 必填)*
  - `session_id` *(string, 可选)*：不传则自动生成。
  - `title` *(string, 可选)*：会话标题。
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
- 响应示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "创建会话成功",
    "data": { "session_id": "3a7e..." }
  }
  ```

### 4. 获取会话详情
- 路径：`GET /chat_service/session/<session_id>`
- 响应：`data` 为会话详情对象，未找到返回 404。字段含义（与表结构一致）：  
  - `id`：自增主键  
  - `session_id`：会话唯一ID  
  - `user_id`：用户ID  
  - `title`：会话标题  
  - `tenant_code`：租户编码  
  - `org_code`：组织编码  
  - `created_at`：创建时间  
  - `updated_at`：更新时间  
  - `is_deleted`：是否删除标记（0 未删除，1 已删除）  
  
  示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "获取会话成功",
    "data": {
      "id": 12,
      "session_id": "3a7e...",
      "user_id": "u123",
      "title": "新对话",
      "tenant_code": "t1",
      "org_code": "orgA",
      "created_at": "2025-12-10 10:23:45",
      "updated_at": "2025-12-10 10:24:12",
      "is_deleted": 0
    }
  }
  ```

### 5. 获取会话消息历史
- 路径：`GET /chat_service/session/<session_id>/messages`
- 查询参数：`limit` *(int, 默认 100)*，按时间倒序限制返回条数。
- 响应：`data` 为消息数组，每条包含：  
  - `id`：消息主键  
  - `session_id`：会话ID  
  - `user_id`：用户ID  
  - `role`：`user` 或 `assistant`  
  - `content`：消息内容  
  - `sources`：JSON，助手回答引用的文档来源数组（可空）  
  - `suggested_questions`：JSON，延申问题列表（可空）  
  - `created_at`：创建时间  
  
  示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "获取消息历史成功",
    "data": [
      {
        "id": 101,
        "session_id": "3a7e...",
        "user_id": "u123",
        "role": "user",
        "content": "请帮我总结一下最新的营销方案要点",
        "sources": null,
        "suggested_questions": null,
        "created_at": "2025-12-10 10:25:00"
      },
      {
        "id": 102,
        "session_id": "3a7e...",
        "user_id": "u123",
        "role": "assistant",
        "content": "要点：1) 目标客群... 2) 渠道组合... 3) 预算与节奏...",
        "sources": [
          { "name": "方案文档", "url": "https://example.com/doc1.pdf" }
        ],
        "suggested_questions": [
          "可否输出一份执行清单？",
          "有哪些可衡量的关键指标？"
        ],
        "created_at": "2025-12-10 10:25:05"
      }
    ]
  }
  ```

### 6. 更新会话标题
- 路径：`PUT /chat_service/session/<session_id>/title`
- 请求体（JSON）：`title` *(string, 必填)*。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "更新标题成功", "data": "" }
  ```

### 7. 删除会话
- 路径：`DELETE /chat_service/session/<session_id>`
- 功能：软删除当前会话。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "删除会话成功", "data": "" }
  ```

### 8. 恢复会话
- 路径：`POST /chat_service/session/<session_id>/restore`
- 功能：恢复被删除的会话。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "恢复会话成功", "data": "" }
  ```

### 9. 上传文件到 MinIO
- 路径：`POST /chat_service/upload`
- Content-Type：`multipart/form-data`
- 表单字段：`file` *(file, 必填)*。
- 响应示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "上传成功",
    "data": {
      "file_url": "https://minio.example.com/bucket/abc.pdf",
      "file_name": "abc.pdf"
    }
  }
  ```

### 10. 上传并解析文件（多文件）
- 路径：`POST /chat_service/upload_and_parse`
- Content-Type：`multipart/form-data`
- 表单字段：`file` 或 `files` *(file array, 必填)*。
- 功能：上传到 MinIO 后解析文本（支持 OCR 配置）。
- 响应 `data`：数组，每个元素包含：
  - `file_name`：文件名
  - `file_url`：存储 URL
  - `content`：解析后的文本内容（成功时）
  - `parse_success`：布尔标识
  - `parse_error`：解析失败时的错误信息
- `msg` 提示处理成功/失败数量，例如 `处理完成，成功2/3个文件`。示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "处理完成，成功2/3个文件",
    "data": [
      {
        "file_name": "doc1.pdf",
        "file_url": "https://minio.example.com/bucket/doc1.pdf",
        "content": "解析后的正文...",
        "parse_success": true
      },
      {
        "file_name": "doc2.pdf",
        "file_url": "https://minio.example.com/bucket/doc2.pdf",
        "content": "",
        "parse_success": false,
        "parse_error": "解析失败: OCR 超时"
      }
    ]
  }
  ```

---

## 二、素材库服务（vector_db_service）

### 1. 创建全局素材库
- 路径：`POST /vector_db_service/new_collection`
- 请求体：空 JSON 即可。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "成功创建全局素材库", "data": "" }
  ```

### 2. 删除素材库数据
- 路径：`POST /vector_db_service/del_collection`
- 请求体（JSON，可选过滤）：
  - `tenant_code` *(string, 可选)*：租户过滤。
  - `org_code` *(string, 可选)*：组织过滤。
- 功能：按过滤条件删除对应 collection 数据，未传则删除全局数据。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "成功删除素材库数据", "data": "" }
  ```

### 3. 添加单个文档
- 路径：`POST /vector_db_service/add_document`
- 请求体（JSON）：
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `doc_url` *(string, 必填)*：文档可访问 URL。
  - `doc_name` *(string, 必填)*：文档名称。
- 流程：校验 URL → OCR/解析获取文本 → 写入向量库。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "成功插入文档到素材库", "data": "" }
  ```

### 4. 批量添加文档
- 路径：`POST /vector_db_service/add_multi_document`
- 请求体（JSON）：
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `multi_doc_urls` *(string[], 必填)*：文档 URL 列表。
  - `doc_names` *(string[], 必填)*：与 URL 一一对应的文档名列表。
- 响应：
  - 全部成功：`status=success`。
  - 部分/全部失败：`status=fail`，`msg` 提示 `成功[x]个,失败[y]个`。
- 示例：  
  ```json
  { "status": "fail", "code": 400, "msg": "插入文档到素材库：成功[3]个,失败[1]个", "data": "" }
  ```

### 5. 删除文档
- 路径：`POST /vector_db_service/del_document`
- 请求体（JSON）：
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `doc_name` *(string[] , 必填)*：待删除文档名列表。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "从全局素材库删除文档成功", "data": "" }
  ```

### 6. 向量库检索
- 路径：`POST /vector_db_service/search_from_vector_db`
- 请求体（JSON）：
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `query` *(string, 必填)*：查询文本。
  - `collection_type` *(string, 必填)*：`DOC` 或 `QA`，决定使用的集合。
  - `filter_expr` *(string, 可选)*：Milvus 表达式过滤，常见示例 `tenant_code == 't1' && org_code == 'orgA'`。
  - `limit` *(int, 默认 5)*：返回条数。
  - `use_hybrid` *(bool, 默认 false)*：是否启用混合检索（向量+倒排）。
  - `vector_similarity_threshold` *(float, 可选)*：向量相似度阈值，不传则不做阈值过滤。
  - `rrf_similarity_threshold` *(float, 可选)*：RRF 相似度阈值。
- 响应 `data`：检索结果结构由 `search_from_collection` 返回，通常包含 `entities` 等字段。示例：  
  ```json
  {
    "status": "success",
    "code": 200,
    "msg": "从素材库查询成功",
    "data": {
      "entities": [
        [
          {
            "question": "产品优势是什么？",
            "answer": "核心优势包括性能和成本优势。",
            "source": "https://example.com/doc1",
            "score": 0.89
          }
        ]
      ]
    }
  }
  ```

### 7. 下载 QA 模板
- 路径：`GET /vector_db_service/download_qa_template`
- 功能：下载 `data/问答库模板.xlsx`，不存在则返回 404。
- 响应：文件流下载；若不存在返回示例：  
  ```json
  { "status": "fail", "code": 404, "msg": "模板文件不存在", "data": "" }
  ```

### 8. 添加 QA（单条/批量）
- 路径：`POST /vector_db_service/add_qa`
- 请求体（JSON）：
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `question` *(string 或 string[], 必填)*：问题，可为单个或列表。
  - `answer` *(string 或 string[], 必填)*：答案，与问题数量一致。
  - `source` *(string 或 string[], 可选)*：来源，若为列表需与问题数量匹配；字符串则复用。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "成功插入2条问答对到素材库", "data": "" }
  ```

### 9. 从模板文件添加 QA
- 路径：`POST /vector_db_service/add_qa_from_template`
- Content-Type：`multipart/form-data`
- 表单字段：
  - `file` *(file, 必填)*：Excel 模板。
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
- 流程：上传临时文件 → 解析模板 → 写入向量库 → 删除临时文件。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "成功插入20条问答对到素材库", "data": "" }
  ```

### 10. 删除 QA
- 路径：`POST /vector_db_service/del_qa`
- 请求体（JSON）：
  - `tenant_code` *(string, 可选)*
  - `org_code` *(string, 可选)*
  - `question` *(string[], 必填)*：需删除的问题列表。
- 响应示例：  
  ```json
  { "status": "success", "code": 200, "msg": "从全局素材库删除问答对成功", "data": "" }
  ```

---

## 三、错误与日志
- 所有接口失败时 `status=fail`，`code` 对应 4xx/5xx，`msg` 会包含具体错误信息或堆栈摘要。
- 服务器端分别记录日志：`chat_service`、`vector_db`，可在部署机器上查看具体原因。

## 四、调用建议
- 建议所有请求携带 `Content-Type: application/json`（上传文件接口除外）。
- 在调用向量库相关接口时，若存在多租户/多组织场景，请务必传入 `tenant_code` 和 `org_code` 以避免数据串扰。
- 流式问答为 SSE 协议，前端需使用 `EventSource` 或等效方式读取。
