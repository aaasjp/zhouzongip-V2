# 向量库+小助手系统部署文档

## 目录

- [环境要求](#环境要求)
- [部署步骤](#部署步骤)
  - [1. 下载代码](#1-下载代码)
  - [2. 下载 Embedding 模型](#2-下载-embedding-模型)
  - [3. 部署 MySQL](#3-部署-mysql)
  - [4. 启动 Milvus](#4-启动-milvus)
  - [5. 构建 Docker 镜像](#5-构建-docker-镜像)
  - [6. 配置系统参数](#6-配置系统参数)
  - [7. 启动服务](#7-启动服务)
  - [8. 验证部署](#8-验证部署)
- [常见问题](#常见问题)

---

## 环境要求

### 系统要求
- **操作系统**: Linux (推荐 Ubuntu 20.04+ 或 CentOS 7+)
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **GPU**: 可选，用于加速 Embedding 模型推理（推荐 NVIDIA GPU，支持 CUDA）

### 硬件要求
- **CPU**: 4 核及以上
- **内存**: 16GB 及以上（推荐 32GB）
- **磁盘**: 至少 50GB 可用空间
- **网络**: 可访问互联网（用于下载模型和依赖）

### 端口要求
确保以下端口未被占用：
- `3306`: MySQL
- `19530`: Milvus
- `9091`: Milvus 健康检查
- `9000`: MinIO
- `9001`: MinIO 控制台
- `8003`: AI 助手服务

---

## 部署步骤

### 1. 下载代码

```bash
# 创建项目目录
mkdir -p /data/milvus_knowledge_server
cd /data/milvus_knowledge_server

# 克隆代码仓库
git clone https://github.com/aaasjp/dexiangzhipei_milvus.git
cd dexiangzhipei_milvus
```

### 2. 下载 Embedding 模型

系统使用 `bge-large-zh-v1.5` 作为 Embedding 模型，需要提前下载并放置到指定目录。

```bash
# 创建模型目录
mkdir -p /data/milvus_knowledge_server/embeddings

# 下载模型（使用 Hugging Face 或从其他源下载）
# 方式1: 使用 git lfs 下载
cd /data/milvus_knowledge_server/embeddings
git lfs install
git clone https://huggingface.co/BAAI/bge-large-zh-v1.5

# 方式2: 如果已有模型文件，直接复制到该目录
# cp -r /path/to/bge-large-zh-v1.5 /data/milvus_knowledge_server/embeddings/
```

**注意**: 确保模型目录结构为 `/data/milvus_knowledge_server/embeddings/bge-large-zh-v1.5/`

### 3. 部署 MySQL

#### 3.1 创建 MySQL 配置文件

创建 `data/my.cnf` 文件（项目根目录下已包含示例文件）：

```ini
[client]
default-character-set = utf8mb4

[mysql]
default-character-set = utf8mb4

[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
skip-character-set-client-handshake = ON
```

#### 3.2 启动 MySQL 容器

```bash
docker run -d \
  --name mysql-zhouzongip \
  --restart=unless-stopped \
  -e MYSQL_ROOT_PASSWORD=root123 \
  -e MYSQL_DATABASE=zhouzongip \
  -e MYSQL_USER=admin \
  -e MYSQL_PASSWORD=admin123 \
  -e TZ=Asia/Shanghai \
  -p 3306:3306 \
  -v /data/mysql-data:/var/lib/mysql \
  -v $(pwd)/data/my.cnf:/etc/mysql/conf.d/custom.cnf \
  mysql:8.0 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci \
  --default-authentication-plugin=mysql_native_password
```

#### 3.3 验证 MySQL 容器

```bash
# 查看容器状态
docker ps | grep mysql

# 查看容器日志
docker logs mysql-zhouzongip

# 进入容器测试连接（使用utf8mb4字符集，避免中文乱码）
docker exec -it mysql-zhouzongip mysql -uroot -proot123 --default-character-set=utf8mb4

# 或者进入后手动设置字符集
docker exec -it mysql-zhouzongip mysql -uroot -proot123
# 在MySQL命令行中执行：SET NAMES utf8mb4;
```

#### 3.4 创建数据库和用户（如果容器启动时未自动创建）

```sql
-- 创建用户 'admin'，密码为 'admin123'
CREATE USER 'admin'@'%' IDENTIFIED BY 'admin123';

-- 创建数据库 gaoguanip
CREATE DATABASE gaoguanip CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 授予该用户对 gaoguanip 数据库的全部权限
GRANT ALL PRIVILEGES ON gaoguanip.* TO 'admin'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 4. 启动 Milvus

Milvus 使用 Docker Compose 部署，包含 etcd、MinIO 和 Milvus 三个服务。

```bash
# 进入 Milvus 部署目录
cd /data/milvus_knowledge_server/dexiangzhipei_milvus/milvus-docker

# 启动 Milvus 服务（后台运行）
docker compose -f docker-compose.yml up -d

# 查看服务状态
docker compose -f docker-compose.yml ps

# 查看服务日志
docker compose -f docker-compose.yml logs -f
```

**等待服务启动**: Milvus 服务启动需要一些时间，可以通过以下命令检查健康状态：

```bash
# 检查 Milvus 健康状态
curl http://localhost:9091/healthz

# 检查 MinIO 健康状态
curl http://localhost:9000/minio/health/live
```

### 5. 构建 Docker 镜像

#### 5.1 构建基础镜像

```bash
# 回到项目根目录
cd /data/milvus_knowledge_server/dexiangzhipei_milvus

# 构建 Docker 镜像
docker build -t zhouzongip:latest -f Dockerfile .

# 查看镜像
docker images | grep zhouzongip
```

**注意**: 构建过程可能需要较长时间，因为需要安装 Python 依赖包。

### 6. 配置系统参数

编辑 `config/config.json` 文件，修改以下配置项：

#### 6.1 大模型配置

```json
"llm": {
  "model": "qwen-max",  // 模型名称
  "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",  // API 地址
  "api_key": "your-api-key"  // 替换为你的 API Key
}
```

#### 6.2 MySQL 配置

```json
"mysql": {
  "host": "127.0.0.1",  // 如果 MySQL 在容器中，使用宿主机 IP 或容器名
  "port": 3306,
  "user": "admin",
  "password": "admin123",
  "db_name": "zhouzongip"
}
```

**注意**: 如果 MySQL 运行在 Docker 容器中，且 AI 助手服务也在容器中运行，需要：
- 使用宿主机 IP 地址（如 `172.17.0.1`）或
- 使用 Docker 网络连接（需要将服务加入同一网络）

#### 6.3 Milvus 配置

```json
"milvus": {
  "host": "127.0.0.1",  // 如果 Milvus 在容器中，使用宿主机 IP
  "port": 19530
}
```

#### 6.4 MinIO 配置

```json
"minio": {
  "endpoint": "127.0.0.1:9000",  // MinIO 服务地址
  "access_key": "minioadmin",
  "secret_key": "minioadmin",
  "secure": false,
  "bucket_name": "aihelper-files",
  "base_url": "http://127.0.0.1:9000"
}
```

#### 6.5 OCR 服务配置

```json
"ocr_service": {
  "base_url": "http://your-ocr-service:8000",  // OCR 服务地址
  "parse_mode": "accuracy",
  "timeout": 3000
}
```

#### 6.6 Embedding 模型路径

```json
"embedding_model_path": "/workspace/embeddings/bge-large-zh-v1.5"
```

**注意**: 此路径为容器内路径，启动容器时需要映射到宿主机的模型目录。

### 7. 启动服务

#### 7.1 不使用 GPU 启动

```bash
docker run -d \
  --name zhouzongip \
  --restart=unless-stopped \
  -p 8002:8002 \
  -p 8003:8003 \
  -v /data/milvus_knowledge_server/embeddings/bge-large-zh-v1.5:/workspace/embeddings/bge-large-zh-v1.5:ro \
  -v $(pwd)/config/config.json:/workspace/config/config.json:ro \
  -v $(pwd)/logs:/workspace/logs \
  zhouzongip:latest
```

#### 7.2 使用 GPU 启动（推荐，加速 Embedding 推理）

```bash
docker run -d \
  --name zhouzongip \
  --restart=unless-stopped \
  --gpus all \
  -p 8002:8002 \
  -p 8003:8003 \
  -v /data/milvus_knowledge_server/embeddings/bge-large-zh-v1.5:/workspace/embeddings/bge-large-zh-v1.5:ro \
  -v $(pwd)/config/config.json:/workspace/config/config.json:ro \
  -v $(pwd)/logs:/workspace/logs \
  zhouzongip:latest
```

**注意**: 
- 使用 GPU 需要安装 [NVIDIA Container Toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html)
- 如果宿主机没有 GPU，可以去掉 `--gpus all` 参数，使用 CPU 运行（速度较慢）

#### 7.3 查看服务日志

```bash
# 查看实时日志
docker logs -f zhouzongip

# 查看最近 100 行日志
docker logs --tail 100 zhouzongip
```

### 8. 验证部署

#### 8.1 检查服务状态

```bash
# 检查容器运行状态
docker ps | grep zhouzongip

# 检查服务健康状态
curl http://localhost:8003/health  # 如果有健康检查接口

# 检查服务日志中是否有错误
docker logs zhouzongip | grep -i error
```

#### 8.2 测试 API 接口

```bash
# 测试向量库服务（示例）
curl -X POST http://localhost:8003/vector_db_service/health

# 测试对话服务（示例）
curl -X POST http://localhost:8003/chat_service/health
```

#### 8.3 访问 Web 界面（如果有）

如果部署了前端服务，可以通过浏览器访问：
- 前端地址: `http://your-server-ip:frontend-port`

---

## 常见问题

### Q1: MySQL 连接失败

**问题**: 容器内无法连接到 MySQL

**解决方案**:
1. 检查 MySQL 容器是否正常运行: `docker ps | grep mysql`
2. 如果 AI 助手服务在容器中，MySQL 配置中的 `host` 应使用宿主机 IP（如 `172.17.0.1`）或 Docker 网络 IP
3. 检查防火墙是否开放 3306 端口
4. 验证 MySQL 用户权限: `GRANT ALL PRIVILEGES ON zhouzongip.* TO 'helper'@'%';`

### Q2: Milvus 连接失败

**问题**: 无法连接到 Milvus

**解决方案**:
1. 检查 Milvus 服务状态: `docker compose -f milvus-docker/docker-compose.yml ps`
2. 检查 Milvus 健康状态: `curl http://localhost:9091/healthz`
3. 如果 AI 助手服务在容器中，Milvus 配置中的 `host` 应使用宿主机 IP
4. 等待 Milvus 完全启动（可能需要 1-2 分钟）

### Q3: Embedding 模型加载失败

**问题**: 模型文件找不到或加载错误

**解决方案**:
1. 确认模型目录已正确映射: `docker exec zhouzongip ls -la /workspace/embeddings/`
2. 检查模型文件完整性
3. 确认模型路径配置正确: `config.json` 中的 `embedding_model_path`

### Q4: GPU 不可用

**问题**: 使用 `--gpus all` 启动失败

**解决方案**:
1. 检查 NVIDIA 驱动: `nvidia-smi`
2. 安装 NVIDIA Container Toolkit
3. 重启 Docker 服务: `sudo systemctl restart docker`
4. 如果不需要 GPU，去掉 `--gpus all` 参数使用 CPU 运行

### Q5: 端口被占用

**问题**: 启动容器时提示端口已被占用

**解决方案**:
1. 检查端口占用: `netstat -tulpn | grep 8003`
2. 修改 `config.json` 中的端口配置
3. 或修改 Docker 启动命令中的端口映射: `-p 8006:8003`

### Q6: 中文乱码

**问题**: 数据库或日志中出现中文乱码

**解决方案**:
1. 确保 MySQL 使用 `utf8mb4` 字符集
2. 检查 `data/my.cnf` 配置文件是否正确
3. 确保数据库创建时指定了字符集: `CREATE DATABASE zhouzongip CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`

### Q7: 服务启动后立即退出

**问题**: 容器启动后立即停止

**解决方案**:
1. 查看详细日志: `docker logs zhouzongip`
2. 检查配置文件格式是否正确（JSON 格式）
3. 检查必要的服务（MySQL、Milvus）是否已启动
4. 检查模型文件路径是否正确

---

## 后续操作

部署完成后，可以：

1. **导入数据**: 使用向量库 API 导入文档和问答数据
2. **测试对话**: 通过对话服务 API 测试问答功能
3. **监控日志**: 定期查看 `logs/` 目录下的日志文件
4. **性能优化**: 根据实际使用情况调整配置参数

更多 API 接口说明请参考: [向量库+小助手API接口文档.md](./向量库+小助手API接口文档.md)
